<!DOCTYPE html>
<!-- docs/baseof.html -->
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="icon" type="image/png" href="/img/favicon.png">
    
    
    <link rel="stylesheet" href="/css/style.css" integrity="" media="screen">
    <script src="/js/main.js" type="text/javascript"></script>
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> 
  
    
      
      <meta name="robots" content="noindex">
    
    <title>Carvel - imgpkg - Air-gapped Workflow</title>
  </head>

  <body id="docs">
    

<header class="in-subproject">
	<div class="wrapper">
		<a href="/"><img class="image" src="/img/logo.svg" alt="Carvel Logo" /></a>
		<ul class="desktop-links">
			<li><a href="/" >Home</a></li>
			<li class="subprojects-in-primary-nav">
				<a href="/" onclick="return false;">Projects</a>
				<ul>
					
					
					<li><a href="/ytt/" >ytt</a></li>
					
					
					<li><a href="/kbld/" >kbld</a></li>
					
					
					<li><a href="/kapp/" >kapp</a></li>
					
					
					<li><a href="/imgpkg/" >imgpkg</a></li>
					
					
					<li><a href="https://github.com/vmware-tanzu/carvel-kapp-controller" >kapp-controller</a></li>
					
					
					<li><a href="/vendir/" >vendir</a></li>
					
				</ul>
			</li>
			<li><a href="/community/" >Community</a></li>
			<li><a href="/blog/" >Blog</a></li>
			<li><a href="https://kubernetes.slack.com/archives/CH8KCCKA5"><img src="/img/slack.png" />#carvel in Kubernetes Slack</a></li>
		</ul>
		<button type="button" class="mobile" onclick="mobileNavToggle()">
			<img class="collapsed-icon" src="/img/hamburger.svg" alt="Mobile nav icon">
			<img class="expanded-icon" src="/img/close.svg" alt="Mobile nav icon">
		</button>
		<div id="mobile-menu" class="mobile-menu mobile">
			<ul class="header-links">
				<li><a href="/" >Home</a></li>
				<li>
					<a href="/">Projects</a>
					<ul>
						
						
						<li><a href="/ytt/" >ytt</a></li>
						
						
						<li><a href="/kbld/" >kbld</a></li>
						
						
						<li><a href="/kapp/" >kapp</a></li>
						
						
						<li><a href="/imgpkg/" >imgpkg</a></li>
						
						
						<li><a href="https://github.com/vmware-tanzu/carvel-kapp-controller" >kapp-controller</a></li>
						
						
						<li><a href="/vendir/" >vendir</a></li>
						
					</ul>
				</li>
				<li><a href="/community/" >Community</a></li>
				<li><a href="/blog/" >Blog</a></li>
			</ul>
			<div class="social">
				<a href="https://github.com/vmware-tanzu/carvel.dev"><img src="/img/github.svg" />GitHub</a>
				<a href="https://kubernetes.slack.com/archives/CH8KCCKA5"><img src="/img/slack.png" />#carvel in Kubernetes Slack</a>
			</div>
		</div>
	</div>
</header>



<header class="subproject-specific">
	<div class="wrapper">
		<a href="/imgpkg/" class="text-logo">imgpkg</a>
		<ul class="desktop-links">
			<li><a href="/imgpkg/" >imgpkg Overview</a></li>
			<li><a href="/imgpkg/docs/latest/" >Documentation</a></li>
			<li><a href="https://github.com/vmware-tanzu/carvel-imgpkg"><img src="/img/github.svg" />GitHub</a></li>
		</ul>
		<ul class="mobile-links mobile">
			<li><a href="/imgpkg/docs/latest/" >Docs</a></li>
			<li><a href="https://github.com/vmware-tanzu/carvel-imgpkg"><img src="/img/github.svg" />GitHub</a></li>
		</ul>
	</div>
</header>


    <main>
      <div class="wrapper dedicated-page docs clearfix">
        <div class="side-nav">
          
<div class="dropdown">
    
        <span>latest</span>
    
</div>

          
    
    <form class="d-flex align-items-center">
        <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;">
        <input type="search" class="form-control docsearch-input" id="search-input" placeholder="Search..."
                aria-label="Search for..." autocomplete="off" spellcheck="false" role="combobox"
                aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0"
                dir="auto" style="position: relative; vertical-align: top;">
        </span>
    </form>

          <nav class="navigation">
  
  
  
  
    
    
    
    

    
      <h3>Introduction</h3>
      <ul>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/" >About imgpkg</a>
            
          </li>
        
      </ul>
    
      <h3>Workflows</h3>
      <ul>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/basic-workflow/" >Basic workflow</a>
            
          </li>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/air-gapped-workflow/" class="active">Air-gapped workflow</a>
            
          </li>
        
      </ul>
    
      <h3>Reference</h3>
      <ul>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/auth/" >Authentication</a>
            
          </li>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/resources/" >Resources</a>
            
          </li>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/commands/" >Commands</a>
            
          </li>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/working-directly-with-images/" >Working directly with images</a>
            
          </li>
        
      </ul>
    
      <h3>FAQ</h3>
      <ul>
        
          <li>
            
              
              <a href="/imgpkg/docs/latest/security/" >Security</a>
            
          </li>
        
      </ul>
    
  
</nav>

        </div>
        <div class="docs-content text-content">
          

	


          <div class="documentation-container">
            <h1>Air-gapped Workflow</h1>
            
                <aside>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#scenario">Scenario</a></li>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#step-1-finding-bundle-in-source-registry">Step 1: Finding bundle in source registry</a></li>
    <li><a href="#step-2-two-methods-of-copying-bundles">Step 2: Two methods of copying bundles</a>
      <ul>
        <li><a href="#option-1-from-a-location-connected-to-both-registries">Option 1: From a location connected to both registries</a></li>
        <li><a href="#option-2-with-intermediate-tarball">Option 2: With intermediate tarball</a></li>
      </ul>
    </li>
    <li><a href="#step-3-pulling-bundle-from-destination-registry">Step 3: Pulling bundle from destination registry</a></li>
    <li><a href="#step-4-use-pulled-bundle-contents">Step 4: Use pulled bundle contents</a></li>
  </ul>
</nav>
                </aside>
            

            <h2 id="scenario">Scenario <a href="#scenario" class="section-link">¶</a></h2><p>You want to ensure Kubernetes application does not rely on images from external registries when deployed.</p>
<p>This scenario <em>also</em> applies when trying to ensure that all images are consolidated into a single registry, even if that registry is not air-gapped.</p>
<h2 id="prerequisites">Prerequisites <a href="#prerequisites" class="section-link">¶</a></h2><p>To complete this workflow you will need access to an OCI registry like Docker Hub, and optionally,
a Kubernetes cluster. (If you would like to use a local registry and Kubernetes cluster, try using <a href="https://kind.sigs.k8s.io/docs/user/local-registry/" target="_blank">Kind</a>)</p>
<p>If you would like to deploy the results of this scenario to your Kubernetes cluster, you will additionally need <a href="/kbld/"><code>kbld</code></a> and kubectl.</p>
<p>If any of your bundles contain <a href="/imgpkg/docs/latest/commands/#non-distributable-or-foreign-layers">non-distributable layers</a> you will need to include
the <code>--include-non-distributable</code> flag to each copy command in the examples provided.</p>
<hr>
<h2 id="step-1-finding-bundle-in-source-registry">Step 1: Finding bundle in source registry <a href="#step-1-finding-bundle-in-source-registry" class="section-link">¶</a></h2><p>If you have already pushed a bundle to the registry, continue to the next step.</p>
<p>If you are trying to bundle your own or third-part software, you will need to create a bundle. Refer to basic workflow&rsquo;s <a href="/imgpkg/docs/latest/basic-workflow/#step-1-creating-the-bundle">&ldquo;Step 1: Creating the bundle&rdquo; and &ldquo;Step 2: Pushing the bundle to registry&rdquo;</a>.</p>
<hr>
<h2 id="step-2-two-methods-of-copying-bundles">Step 2: Two methods of copying bundles <a href="#step-2-two-methods-of-copying-bundles" class="section-link">¶</a></h2><p>You have two options how to transfer bundle from one registry to another:</p>
<ul>
<li>Option 1: From a common location connected to both registries. This option is more efficient because only changed image layers will be transfered between registries.</li>
<li>Option 2: With intermediate tarball. This option works best when registries have no common network access.</li>
</ul>
<h3 id="option-1-from-a-location-connected-to-both-registries">Option 1: From a location connected to both registries <a href="#option-1-from-a-location-connected-to-both-registries" class="section-link">¶</a></h3><ol>
<li>
<p>Get to a location that can access both registries</p>
<p>This may be a server that has access to both internal and external networks. If there is no such location, you will have to use &ldquo;Option 2&rdquo; below.</p>
</li>
<li>
<p><a href="/imgpkg/docs/latest/auth/">Authenticate</a> with both source, and destination registries</p>
</li>
<li>
<p>Run following command to copy bundle from one registry to another:</p>
<pre><code class="language-bash-plain" data-lang="bash-plain">$ imgpkg copy -b index.docker.io/user1/simple-app-bundle:v1.0.0 --to-repo registry.corp.com/apps/simple-app-bundle

copy | exporting 2 images...
copy | will export index.docker.io/user1/simple-app-bundle@sha256:4c8b96d4fffdfae29258d94a22ae4ad1fe36139d47288b8960d9958d1e63a9d0
copy | will export index.docker.io/user1/simple-app-bundle@sha256:70225df0a05137ac385c95eb69f89ded3e7ef3a0c34db43d7274fd9eba3705bb
copy | exported 2 images
copy | importing 2 images...
copy | importing index.docker.io/user1/simple-app-bundle@sha256:70225df0a05137ac385c95eb69f89ded3e7ef3a0c34db43d7274fd9eba3705bb
       -&gt; registry.corp.com/apps/simple-app-bundle@sha256:70225df0a05137ac385c95eb69f89ded3e7ef3a0c34db43d7274fd9eba3705bb...
copy | importing index.docker.io/user1/simple-app-bundle@sha256:4c8b96d4fffdfae29258d94a22ae4ad1fe36139d47288b8960d9958d1e63a9d0
       -&gt; registry.corp.com/apps/simple-app-bundle@sha256:4c8b96d4fffdfae29258d94a22ae4ad1fe36139d47288b8960d9958d1e63a9d0...
copy | imported 2 images
Succeeded
</code></pre><p>The bundle, and all images referenced in the bundle, are copied to the destination registry.</p>
<p>Flags used in the command:</p>
<ul>
<li><code>-b</code> (<code>--bundle</code>) indicates the bundle location in the source registry</li>
<li><code>--to-repo</code> indicates the registry where the bundle and associated images should be copied to</li>
</ul>
</li>
</ol>
<h3 id="option-2-with-intermediate-tarball">Option 2: With intermediate tarball <a href="#option-2-with-intermediate-tarball" class="section-link">¶</a></h3><ol>
<li>
<p>Get to a location that can access source registry</p>
</li>
<li>
<p><a href="/imgpkg/docs/latest/auth/">Authenticate with the source registry</a></p>
</li>
<li>
<p>Save the bundle to a tarball</p>
<pre><code class="language-bash-plain" data-lang="bash-plain">$ imgpkg copy -b index.docker.io/user1/simple-app-bundle:v1.0.0 --to-tar /tmp/my-image.tar

copy | exporting 2 images...
copy | will export index.docker.io/user1/simple-app-bundle@sha256:4c8b96d4fffdfae29258d94a22ae4ad1fe36139d47288b8960d9958d1e63a9d0
copy | will export index.docker.io/user1/simple-app-bundle@sha256:70225df0a05137ac385c95eb69f89ded3e7ef3a0c34db43d7274fd9eba3705bb
copy | exported 2 images
copy | writing layers...
copy | done: file 'manifest.json' (13.71µs)
copy | done: file 'sha256-233f1d0dbdc8cf675af965df8639b0dfd4ef7542dfc9fcfd03bfc45c570b0e4d.tar.gz' (47.616µs)
copy | done: file 'sha256-8ece9ac45f2b7228b2ed95e9f407b4f0dc2ac74f93c62ff1156f24c53042ba54.tar.gz' (43.204905ms)
Succeeded
</code></pre><p>Flags used in the command:</p>
<ul>
<li><code>-b</code> (<code>--bundle</code>) indicates the bundle location in the source registry</li>
<li><code>--to-tar</code> indicates the local location to write a tar file containing the bundle assets</li>
</ul>
</li>
<li>
<p>Transfer the local tarball <code>/tmp/my-image.tar</code> to a location with access to the destination registry</p>
</li>
<li>
<p><a href="/imgpkg/docs/latest/auth/">Authenticate with the destination registry</a></p>
</li>
<li>
<p>Import the bundle from your tarball to the destination registry:</p>
<pre><code class="language-bash-plain" data-lang="bash-plain">$ imgpkg copy --tar /tmp/my-image.tar --to-repo registry.corp.com/apps/simple-app-bundle

copy | importing 2 images...
copy | importing index.docker.io/user1/simple-app-bundle@sha256:70225df0a05137ac385c95eb69f89ded3e7ef3a0c34db43d7274fd9eba3705bb -&gt; registry.corp.com/apps/simple-app-bundle@sha256:70225df0a05137ac385c95eb69f89ded3e7ef3a0c34db43d7274fd9eba3705bb...
copy | importing index.docker.io/user1/simple-app-bundle@sha256:4c8b96d4fffdfae29258d94a22ae4ad1fe36139d47288b8960d9958d1e63a9d0 -&gt; registry.corp.com/apps/simple-app-bundle@sha256:4c8b96d4fffdfae29258d94a22ae4ad1fe36139d47288b8960d9958d1e63a9d0...
copy | imported 2 images
Succeeded
</code></pre><p>The bundle, and all images referenced in the bundle, are copied to the destination registry.</p>
<p>Flags used in the command:</p>
<ul>
<li><code>--tar</code> indicates the path to a tar file containing the assets to be copied to a registry</li>
<li><code>--to-repo</code> indicates destination bundle location in the registry</li>
</ul>
</li>
</ol>
<hr>
<h2 id="step-3-pulling-bundle-from-destination-registry">Step 3: Pulling bundle from destination registry <a href="#step-3-pulling-bundle-from-destination-registry" class="section-link">¶</a></h2><ol>
<li>
<p><a href="/imgpkg/docs/latest/auth/">Authenticate with the destination registry</a></p>
</li>
<li>
<p>Pull the bundle from the destination registry:</p>
<pre><code class="language-bash-plain" data-lang="bash-plain">$ imgpkg pull -b registry.corp.com/apps/simple-app-bundle:v1.0.0 -o /tmp/bundle

Pulling image 'registry.corp.com/apps/simple-app-bundle@sha256:70225df0a05137ac385c95eb69f89ded3e7ef3a0c34db43d7274fd9eba3705bb'
Extracting layer 'sha256:233f1d0dbdc8cf675af965df8639b0dfd4ef7542dfc9fcfd03bfc45c570b0e4d' (1/1)
Locating image lock file images...
All images found in bundle repo; updating lock file: /tmp/bundle/.imgpkg/images.yml

Succeeded
</code></pre><p>Flags used in the command:</p>
<ul>
<li><code>-b</code> (<code>--bundle</code>) indicates to pull a particular bundle from a registry</li>
<li><code>-o</code> (<code>--output</code>) indicates the local folder where the bundle will be unpacked</li>
</ul>
<p>Note that the <code>.imgpkg/images.yml</code> file was updated with the destination registry locations of the images. This happened because, in the prior step, the images referenced by the bundle were copied into the destination registry.</p>
<pre><code class="language-bash-plain" data-lang="bash-plain">$ cat /tmp/bundle/.imgpkg/images.yml
apiVersion: imgpkg.carvel.dev/v1alpha1
kind: ImagesLock
images:
- image: registry.corp.com/apps/simple-app-bundle@sha256:4c8b96d4fffdfae29258d94a22ae4ad1fe36139d47288b8960d9958d1e63a9d0
  annotations:
    kbld.carvel.dev/id: docker.io/dkalinin/k8s-simple-app
</code></pre></li>
</ol>
<hr>
<h2 id="step-4-use-pulled-bundle-contents">Step 4: Use pulled bundle contents <a href="#step-4-use-pulled-bundle-contents" class="section-link">¶</a></h2><p>Regardless which location the bundle is downloaded from, source registry or destination registry, use of the pulled bundle contents remains the same. Continue with <a href="/imgpkg/docs/latest/basic-workflow/#step-4-use-pulled-bundle-contents">&ldquo;Step 4: Use pulled bundle contents&rdquo;</a> in the basic workflow.</p>

          </div>
        </div>
      </div>
    </main>
    <footer>
	<div class="wrapper footer-links">
		<div class="clearfix">
			<ul class="left-links">
				<li><a href="https://twitter.com/carvel_dev"><img src="/img/twitter.png" />Twitter</a></li>
				<li><a href="https://github.com/vmware-tanzu/carvel.dev"><img src="/img/github.svg" />Github</a></li>
				<li><a href="https://kubernetes.slack.com/archives/CH8KCCKA5">
					<img src="/img/slack.png" />
					<span class="desktop">#carvel in Kubernetes Slack</span>
					<span class="mobile">Slack</span>
				</a></li>
			</ul>
			<div class="right-links">
				<a href="/"> <img src="/img/logo.svg" /></a>
			</div>
		</div>
		<div class="bottom-links">
			<p class="copywrite">&copy; 2021 Carvel Authors. <a href="http://vmware.github.io/">A VMware-backed project. <img src="/img/vm-logo.svg" /></a></p>
		</div>
	</div>
</footer>

    
    
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
      <script type="text/javascript">
        docsearch({
          apiKey: '582b1408d7a3fe145c0f84f48ca03755',
          indexName: 'carvel',
          inputSelector: '.docsearch-input',
          algoliaOptions: {'facetFilters': ["tags:imgpkg"], hitsPerPage: 9},
          debug: false 
        });
      </script>
    
  </body>
</html>
