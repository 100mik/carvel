<!DOCTYPE html>
<!-- docs/baseof.html -->
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="icon" type="image/png" href="/img/favicon.png">
    
    
    <link rel="stylesheet" href="/css/style.css" integrity="" media="screen">
    <script src="/js/main.js" type="text/javascript"></script>
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> 
  
    
      
      <meta name="robots" content="noindex">
    
    <title>Carvel - kbld - Packaging and Relocation</title>
  </head>

  <body id="docs">
    

<header class="in-subproject">
	<div class="wrapper">
		<a href="/"><img class="image" src="/img/logo.svg" alt="Carvel Logo" /></a>
		<ul class="desktop-links">
			<li><a href="/" >Home</a></li>
			<li class="subprojects-in-primary-nav">
				<a href="/" onclick="return false;">Projects</a>
				<ul>
					
					
					<li><a href="/ytt/" >ytt</a></li>
					
					
					<li><a href="/kbld/" >kbld</a></li>
					
					
					<li><a href="/kapp/" >kapp</a></li>
					
					
					<li><a href="/imgpkg/" >imgpkg</a></li>
					
					
					<li><a href="https://github.com/vmware-tanzu/carvel-kapp-controller" >kapp-controller</a></li>
					
					
					<li><a href="/vendir/" >vendir</a></li>
					
				</ul>
			</li>
			<li><a href="/community/" >Community</a></li>
			<li><a href="/blog/" >Blog</a></li>
			<li><a href="https://kubernetes.slack.com/archives/CH8KCCKA5"><img src="/img/slack.png" />#carvel in Kubernetes Slack</a></li>
		</ul>
		<button type="button" class="mobile" onclick="mobileNavToggle()">
			<img class="collapsed-icon" src="/img/hamburger.svg" alt="Mobile nav icon">
			<img class="expanded-icon" src="/img/close.svg" alt="Mobile nav icon">
		</button>
		<div id="mobile-menu" class="mobile-menu mobile">
			<ul class="header-links">
				<li><a href="/" >Home</a></li>
				<li>
					<a href="/">Projects</a>
					<ul>
						
						
						<li><a href="/ytt/" >ytt</a></li>
						
						
						<li><a href="/kbld/" >kbld</a></li>
						
						
						<li><a href="/kapp/" >kapp</a></li>
						
						
						<li><a href="/imgpkg/" >imgpkg</a></li>
						
						
						<li><a href="https://github.com/vmware-tanzu/carvel-kapp-controller" >kapp-controller</a></li>
						
						
						<li><a href="/vendir/" >vendir</a></li>
						
					</ul>
				</li>
				<li><a href="/community/" >Community</a></li>
				<li><a href="/blog/" >Blog</a></li>
			</ul>
			<div class="social">
				<a href="https://github.com/vmware-tanzu/carvel.dev"><img src="/img/github.svg" />GitHub</a>
				<a href="https://kubernetes.slack.com/archives/CH8KCCKA5"><img src="/img/slack.png" />#carvel in Kubernetes Slack</a>
			</div>
		</div>
	</div>
</header>



<header class="subproject-specific">
	<div class="wrapper">
		<a href="/kbld/" class="text-logo">kbld</a>
		<ul class="desktop-links">
			<li><a href="/kbld/" >kbld Overview</a></li>
			<li><a href="/kbld/docs/latest/" >Documentation</a></li>
			<li><a href="https://github.com/vmware-tanzu/carvel-kbld"><img src="/img/github.svg" />GitHub</a></li>
		</ul>
		<ul class="mobile-links mobile">
			<li><a href="/kbld/docs/latest/" >Docs</a></li>
			<li><a href="https://github.com/vmware-tanzu/carvel-kbld"><img src="/img/github.svg" />GitHub</a></li>
		</ul>
	</div>
</header>


    <main>
      <div class="wrapper dedicated-page docs clearfix">
        <div class="side-nav">
          
<div class="dropdown">
    
        <span>latest</span>
    
</div>

          
    
    <form class="d-flex align-items-center">
        <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;">
        <input type="search" class="form-control docsearch-input" id="search-input" placeholder="Search..."
                aria-label="Search for..." autocomplete="off" spellcheck="false" role="combobox"
                aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0"
                dir="auto" style="position: relative; vertical-align: top;">
        </span>
    </form>

          <nav class="navigation">
  
  
  
  
    
    
    
    

    
      <h3>Introduction</h3>
      <ul>
        
          <li>
            
              
              <a href="/kbld/docs/latest/" >About kbld</a>
            
          </li>
        
      </ul>
    
      <h3>Usage</h3>
      <ul>
        
          <li>
            
              
              <a href="/kbld/docs/latest/resolving/" >Resolving images</a>
            
          </li>
        
          <li>
            
              
              <a href="/kbld/docs/latest/building/" >Building images</a>
            
          </li>
        
          <li>
            
              
              <a href="/kbld/docs/latest/packaging/" class="active">Packaging &amp; Relocation</a>
            
          </li>
        
          <li>
            
              
              <a href="/kbld/docs/latest/cnab-image-relocation/" >CNAB Image Mappings</a>
            
          </li>
        
      </ul>
    
      <h3>Reference</h3>
      <ul>
        
          <li>
            
              
              <a href="/kbld/docs/latest/config/" >Configuration</a>
            
          </li>
        
          <li>
            
              
              <a href="/kbld/docs/latest/auth/" >Authentication</a>
            
          </li>
        
      </ul>
    
      <h3>FAQ</h3>
      <ul>
        
          <li>
            
              
              <a href="/kbld/docs/latest/security/" >Security</a>
            
          </li>
        
      </ul>
    
  
</nav>

        </div>
        <div class="docs-content text-content">
          

	


          <div class="documentation-container">
            <h1>Packaging and Relocation</h1>
            
                <aside>
                <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#deprecation">Deprecation</a></li>
      </ul>
    </li>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#with-lock-file">With lock file</a></li>
    <li><a href="#directly-against-configuration">Directly against configuration</a></li>
    <li><a href="#authentication">Authentication</a></li>
    <li><a href="#using-with-gcrio">Using with gcr.io</a></li>
    <li><a href="#using-with-aws-ecr">Using with AWS ECR</a></li>
    <li><a href="#using-with-harbor">Using with Harbor</a></li>
    <li><a href="#notes">Notes</a></li>
  </ul>
</nav>
                </aside>
            

            <h3 id="deprecation">Deprecation <a href="#deprecation" class="section-link">¶</a></h3><p>This functionality was deprecated in <code>kbld</code> starting from version v0.30.0 and will be removed soon.
These features are now available on <a href="https://carvel.dev/imgpkg" target="_blank">imgpkg</a>.</p>
<h2 id="overview">Overview <a href="#overview" class="section-link">¶</a></h2><p>kbld provides a way to relocate (i.e. copy) images between multiple registries. Two approaches are available:</p>
<ul>
<li><code>kbld relocate</code> (available v0.23.0+) allows to efficiently copy images between registries as long as running <code>relocate</code> command has connectivity to both registries.</li>
<li><code>kbld package</code> and <code>kbld unpackage</code> allows to export images into a single tarball, and later import them from given tarball into a different (or same) registry. This approach does <em>not</em> require connectivity to source registry during the <code>pkg unpackage</code> time.</li>
</ul>
<p>Use cases:</p>
<ul>
<li>packaging applications for fully offline environments with a private registry</li>
<li>copying images from one registry to another</li>
<li>backing up images</li>
</ul>
<p>There are two approaches to do this:</p>
<ul>
<li>With lock file (recommended)</li>
<li>Directly against configuration</li>
</ul>
<h2 id="with-lock-file">With lock file <a href="#with-lock-file" class="section-link">¶</a></h2><p>For example, to package referenced images into a single tarball:</p>
<ol>
<li>
<p>Produce lock file for referenced images in configuration</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /tmp/manifest
images:
- image: nginx
- image: haproxy

$ kbld -f /tmp/manifest --lock-output /tmp/manifest.lock
...

$ cat /tmp/manifest.lock
apiVersion: kbld.k14s.io/v1alpha1
kind: Config
minimumRequiredVersion: 0.21.0
overrides:
- image: haproxy
  newImage: index.docker.io/library/haproxy@sha256:e6f9faf0c2a0cf2d2d5a53307351fa896d90ca9ccd62817c24026460d97dde92
  preresolved: <span style="color:#0086b3">true</span>
- image: nginx
  newImage: index.docker.io/library/nginx@sha256:86ae264c3f4acb99b2dee4d0098c40cb8c46dcf9e1148f05d3a51c4df6758c12
  preresolved: <span style="color:#0086b3">true</span>
</code></pre></div></li>
<li>
<p>Feed <code>/tmp/manifest.lock</code> to <code>kbld pkg</code> command to download images and pack them into a single tarball <code>/tmp/packaged-images.tar</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kbld pkg -f /tmp/manifest.lock --output /tmp/packaged-images.tar
package | exporting <span style="color:#099">2</span> images...
package | will <span style="color:#0086b3">export</span> index.docker.io/library/nginx@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c
package | will <span style="color:#0086b3">export</span> index.docker.io/library/haproxy@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5
package | exported <span style="color:#099">2</span> images

$ ls -lah /tmp/packaged-images.tar
-rw-r--r-- <span style="color:#099">1</span> root root 314M May  <span style="color:#099">3</span> 18:59 /tmp/packaged-images.tar
</code></pre></div><p>Note: Depending on your internet connection this may be slow.</p>
</li>
</ol>
<p>To import packaged images from a tarball:</p>
<ol>
<li>
<p>Specify new repository location <code>docker.io/dkalinin/app1</code> and provide tarball:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kbld unpkg -f /tmp/manifest.lock --input /tmp/packaged-images.tar --repository docker.io/dkalinin/app1 --lock-output /tmp/manifest.lock.copied
unpackage | importing <span style="color:#099">2</span> images...
unpackage | importing index.docker.io/library/nginx@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c -&gt; docker.io/dkalinin/app1@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c...
unpackage | importing index.docker.io/library/haproxy@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5 -&gt; docker.io/dkalinin/app1@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5...
unpackage | imported <span style="color:#099">2</span> images
</code></pre></div><p>Images will be imported under a single new repository <code>docker.io/dkalinin/app1</code>. <strong>You are guaranteed that images are exactly same as they are referenced by the same digests in produced YAML configuration (though under a different repository name)</strong>.</p>
</li>
<li>
<p><strong>Alternatively</strong>, using <code>relocate</code> command against a lock file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kbld relocate -f /tmp/manifest.lock --repository docker.io/dkalinin/app1 --lock-output /tmp/manifest.lock.copied
relocate | ...
</code></pre></div></li>
<li>
<p>Use newely generated lock file with configuration to get updated results</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kbld -f /tmp/manifest -f /tmp/manifest.lock.copied
images:
- image: docker.io/dkalinin/app1@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c
- image: docker.io/dkalinin/app1@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5
</code></pre></div></li>
</ol>
<hr>
<h2 id="directly-against-configuration">Directly against configuration <a href="#directly-against-configuration" class="section-link">¶</a></h2><p>For example, to package referenced images into a single tarball:</p>
<ol>
<li>
<p>First make sure all image references are in their digest form</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /tmp/manifest
images:
- image: nginx
- image: haproxy

$ kbld -f /tmp/manifest &gt; /tmp/resolved-manifest
resolve | final: haproxy -&gt; index.docker.io/library/haproxy@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5
resolve | final: nginx -&gt; index.docker.io/library/nginx@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c

$ cat /tmp/resolved-manifest
images:
- image: index.docker.io/library/nginx@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c
- image: index.docker.io/library/haproxy@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5
</code></pre></div></li>
<li>
<p>Feed <code>/tmp/resolved-manifest</code> to <code>kbld pkg</code> command to download images and pack them into a single tarball <code>/tmp/packaged-images.tar</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kbld pkg -f /tmp/resolved-manifest --output /tmp/packaged-images.tar
package | exporting <span style="color:#099">2</span> images...
package | will <span style="color:#0086b3">export</span> index.docker.io/library/nginx@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c
package | will <span style="color:#0086b3">export</span> index.docker.io/library/haproxy@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5
package | exported <span style="color:#099">2</span> images

$ ls -lah /tmp/packaged-images.tar
-rw-r--r-- <span style="color:#099">1</span> root root 314M May  <span style="color:#099">3</span> 18:59 /tmp/packaged-images.tar
</code></pre></div><p>Note: Depending on your internet connection this may be slow.</p>
</li>
</ol>
<p>To import packaged images from a tarball:</p>
<ol>
<li>
<p>Specify new repository location <code>docker.io/dkalinin/app1</code> and provide tarball:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kbld unpkg -f /tmp/resolved-manifest --input /tmp/packaged-images.tar --repository docker.io/dkalinin/app1
unpackage | importing <span style="color:#099">2</span> images...
unpackage | importing index.docker.io/library/nginx@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c -&gt; docker.io/dkalinin/app1@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c...
unpackage | importing index.docker.io/library/haproxy@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5 -&gt; docker.io/dkalinin/app1@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5...
unpackage | imported <span style="color:#099">2</span> images
images:
- image: docker.io/dkalinin/app1@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c
- image: docker.io/dkalinin/app1@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5
</code></pre></div><p>Images will be imported under a single new repository <code>docker.io/dkalinin/app1</code>. <strong>You are guaranteed that images are exactly same as they are referenced by the same digests in produced YAML configuration (though under a different repository name)</strong>.</p>
</li>
<li>
<p><strong>Alternatively</strong>, using <code>relocate</code> command:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kbld relocate -f /tmp/resolved-manifest --repository docker.io/dkalinin/app1
relocate | ...
images:
- image: docker.io/dkalinin/app1@sha256:e71b1bf4281f25533cf15e6e5f9be4dac74d2328152edf7ecde23abc54e16c1c
- image: docker.io/dkalinin/app1@sha256:6dae9c8674e2e5f418c3dd040041a05f6b490597315139c0bcacadf65a46cfd5
</code></pre></div></li>
</ol>
<hr>
<h2 id="authentication">Authentication <a href="#authentication" class="section-link">¶</a></h2><p>See general authentication steps in <a href="/kbld/docs/latest/auth/">Authentication doc</a>.</p>
<h2 id="using-with-gcrio">Using with gcr.io <a href="#using-with-gcrio" class="section-link">¶</a></h2><ul>
<li>Run <code>kbld unpkg -f /tmp/resolved-manifest --input /tmp/packaged-images.tar --repository gcr.io/{project-id}/app1</code> to import images (e.g. project id is <code>dkalinin</code>)</li>
</ul>
<h2 id="using-with-aws-ecr">Using with AWS ECR <a href="#using-with-aws-ecr" class="section-link">¶</a></h2><p><strong>Note</strong>: AWS ECR does not support manifest list media types from Docker Registry v2 API. Manifest lists are used for images that are built against multiple architectures and platforms and are referenced through a single digest or tag. Most user-built images do not use manifest lists (as it&rsquo;s a single image); however, common Docker Hub library images are represented by manifest lists and will fail upon import into AWS ECR. You will see following error: <code>Writing image index: Retried 5 times: uploading manifest2: UNSUPPORTED: Invalid parameter at 'imageTag' failed to satisfy constraint: 'must satisfy regular expression '[a-zA-Z0-9-_.]+'</code>. Related <a href="https://forums.aws.amazon.com/thread.jspa?threadID=292294" target="_blank">AWS feature request</a>).</p>
<ul>
<li>Run <code>kbld unpkg -f /tmp/resolved-manifest --input /tmp/packaged-images.tar --repository {uri}</code> to import images (e.g. uri is <code>823869848626.dkr.ecr.us-east-1.amazonaws.com/k14s/kbld-test</code>)</li>
</ul>
<h2 id="using-with-harbor">Using with Harbor <a href="#using-with-harbor" class="section-link">¶</a></h2><p>You may have to provide <code>--registry-ca-cert-path</code> flag with a path to a CA certificate file for Harbor Registry API.</p>
<h2 id="notes">Notes <a href="#notes" class="section-link">¶</a></h2><ul>
<li>Produced tarball does not have duplicate image layers, as they are named by their digest (see <code>tar tvf /tmp/packaged-images.tar</code>).</li>
<li>If digest reference points to an image index, all children (images and other image indexes) will be included in the export. Saving only a portion of contents would of course change the digest.</li>
<li>Only Docker v2 and OCI images and indexes are supported. Docker v1 format is not supported, hence, not all images out there could be exported and only registries supporting v2 format can be used for imports.</li>
<li>Images that once were in different repositories are imported into the same repository to make it easier to manage them in bulk.</li>
</ul>

          </div>
        </div>
      </div>
    </main>
    <footer>
	<div class="wrapper footer-links">
		<div class="clearfix">
			<ul class="left-links">
				<li><a href="https://twitter.com/carvel_dev"><img src="/img/twitter.png" />Twitter</a></li>
				<li><a href="https://github.com/vmware-tanzu/carvel.dev"><img src="/img/github.svg" />Github</a></li>
				<li><a href="https://kubernetes.slack.com/archives/CH8KCCKA5">
					<img src="/img/slack.png" />
					<span class="desktop">#carvel in Kubernetes Slack</span>
					<span class="mobile">Slack</span>
				</a></li>
			</ul>
			<div class="right-links">
				<a href="/"> <img src="/img/logo.svg" /></a>
			</div>
		</div>
		<div class="bottom-links">
			<p class="copywrite">&copy; 2021 Carvel Authors. <a href="http://vmware.github.io/">A VMware-backed project. <img src="/img/vm-logo.svg" /></a></p>
		</div>
	</div>
</footer>

    
    
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
      <script type="text/javascript">
        docsearch({
          apiKey: '582b1408d7a3fe145c0f84f48ca03755',
          indexName: 'carvel',
          inputSelector: '.docsearch-input',
          algoliaOptions: {'facetFilters': ["tags:kbld"], hitsPerPage: 9},
          debug: false 
        });
      </script>
    
  </body>
</html>
