<!DOCTYPE html>
<!-- docs/baseof.html -->
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="icon" type="image/png" href="/img/favicon.png">
    
    
    <link rel="stylesheet" href="/css/style.css" integrity="" media="screen">
    <script src="/js/main.js" type="text/javascript"></script>
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> 
  
    
      
      <meta name="robots" content="noindex">
    
    <title>Carvel - kapp - </title>
  </head>

  <body id="docs">
    

<header class="in-subproject">
	<div class="wrapper">
		<a href="/"><img class="image" src="/img/logo.svg" alt="Carvel Logo" /></a>
		<ul class="desktop-links">
			<li><a href="/" >Home</a></li>
			<li class="subprojects-in-primary-nav">
				<a href="/" onclick="return false;">Projects</a>
				<ul>
					
					
					<li><a href="/ytt/" >ytt</a></li>
					
					
					<li><a href="/kbld/" >kbld</a></li>
					
					
					<li><a href="/kapp/" >kapp</a></li>
					
					
					<li><a href="/imgpkg/" >imgpkg</a></li>
					
					
					<li><a href="https://github.com/vmware-tanzu/carvel-kapp-controller" >kapp-controller</a></li>
					
					
					<li><a href="/vendir/" >vendir</a></li>
					
				</ul>
			</li>
			<li><a href="/community/" >Community</a></li>
			<li><a href="/blog/" >Blog</a></li>
			<li><a href="https://kubernetes.slack.com/archives/CH8KCCKA5"><img src="/img/slack.png" />#carvel in Kubernetes Slack</a></li>
		</ul>
		<button type="button" class="mobile" onclick="mobileNavToggle()">
			<img class="collapsed-icon" src="/img/hamburger.svg" alt="Mobile nav icon">
			<img class="expanded-icon" src="/img/close.svg" alt="Mobile nav icon">
		</button>
		<div id="mobile-menu" class="mobile-menu mobile">
			<ul class="header-links">
				<li><a href="/" >Home</a></li>
				<li>
					<a href="/">Projects</a>
					<ul>
						
						
						<li><a href="/ytt/" >ytt</a></li>
						
						
						<li><a href="/kbld/" >kbld</a></li>
						
						
						<li><a href="/kapp/" >kapp</a></li>
						
						
						<li><a href="/imgpkg/" >imgpkg</a></li>
						
						
						<li><a href="https://github.com/vmware-tanzu/carvel-kapp-controller" >kapp-controller</a></li>
						
						
						<li><a href="/vendir/" >vendir</a></li>
						
					</ul>
				</li>
				<li><a href="/community/" >Community</a></li>
				<li><a href="/blog/" >Blog</a></li>
			</ul>
			<div class="social">
				<a href="https://github.com/vmware-tanzu/carvel.dev"><img src="/img/github.svg" />GitHub</a>
				<a href="https://kubernetes.slack.com/archives/CH8KCCKA5"><img src="/img/slack.png" />#carvel in Kubernetes Slack</a>
			</div>
		</div>
	</div>
</header>



<header class="subproject-specific">
	<div class="wrapper">
		<a href="/kapp/" class="text-logo">kapp</a>
		<ul class="desktop-links">
			<li><a href="/kapp/" >kapp Overview</a></li>
			<li><a href="/kapp/docs/latest/" >Documentation</a></li>
			<li><a href="https://github.com/vmware-tanzu/carvel-kapp"><img src="/img/github.svg" />GitHub</a></li>
		</ul>
		<ul class="mobile-links mobile">
			<li><a href="/kapp/docs/latest/" >Docs</a></li>
			<li><a href="https://github.com/vmware-tanzu/carvel-kapp"><img src="/img/github.svg" />GitHub</a></li>
		</ul>
	</div>
</header>


    <main>
      <div class="wrapper dedicated-page docs clearfix">
        <div class="side-nav">
          
<div class="dropdown">
    
        <span>latest</span>
    
</div>

          
    
    <form class="d-flex align-items-center">
        <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;">
        <input type="search" class="form-control docsearch-input" id="search-input" placeholder="Search..."
                aria-label="Search for..." autocomplete="off" spellcheck="false" role="combobox"
                aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0"
                dir="auto" style="position: relative; vertical-align: top;">
        </span>
    </form>

          <nav class="navigation">
  
  
  
  
    
    
    
    

    
      <h3>Introduction</h3>
      <ul>
        
          <li>
            
              
              <a href="/kapp/docs/latest/" >About kapp</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/apps/" >Applications</a>
            
          </li>
        
      </ul>
    
      <h3>Deploy command</h3>
      <ul>
        
          <li>
            
              
              <a href="/kapp/docs/latest/diff/" >Diff stage</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/apply/" >Apply stage</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/apply-ordering/" >Apply Ordering</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/apply-waiting/" >Apply Waiting</a>
            
          </li>
        
      </ul>
    
      <h3>Reference</h3>
      <ul>
        
          <li>
            
              
              <a href="/kapp/docs/latest/config/" >Configuration</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/rbac/" >Permissions</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/state-namespace/" >Namespace for State Storage</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/cheatsheet/" >Cheatsheet</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/dangerous-flags/" >Dangerous Flags</a>
            
          </li>
        
      </ul>
    
      <h3>Integrations</h3>
      <ul>
        
          <li>
            
              
              <a href="/kapp/docs/latest/integrating-with-other-tools/" >Integrating With Other Tools</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/gitops/" >GitOps</a>
            
          </li>
        
      </ul>
    
      <h3>FAQ</h3>
      <ul>
        
          <li>
            
              
              <a href="/kapp/docs/latest/faq/" >FAQ</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/merge-method/" >Resource Merge Method</a>
            
          </li>
        
          <li>
            
              
              <a href="/kapp/docs/latest/security/" >Security</a>
            
          </li>
        
      </ul>
    
  
</nav>

        </div>
        <div class="docs-content text-content">
          

	


          <div class="documentation-container">
            
            
                <aside>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#persistentvolumeclaim-rebase">PersistentVolumeClaim rebase</a></li>
  </ul>
</nav>
                </aside>
            

            <h2 id="persistentvolumeclaim-rebase">PersistentVolumeClaim rebase <a href="#persistentvolumeclaim-rebase" class="section-link">Â¶</a></h2><p>Here is an example on how to use custom <code>rebaseRules</code> to &ldquo;prefer&rdquo; server chosen value for several annotations added by PVC controller (in other words, cluster owned fields), instead of removing them based on given configuration.</p>
<p>Let&rsquo;s deploy via <code>kapp deploy -a test -f config.yml -c</code> with following configuration <code>config.yml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>PersistentVolumeClaim<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>mysqlclaim<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">accessModes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- ReadWriteOnce<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">requests</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">storage</span>:<span style="color:#bbb"> </span>5Gi<span style="color:#bbb">
</span></code></pre></div><p>Without additional rebase rules following diff will be presented upon next deploy, stating that several annotations will be removed (since they were not present in the initial configuration):</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kapp deploy -a <span style="color:#0086b3">test</span> -f config.yml -c

Target cluster <span style="color:#d14">&#39;https://x.x.x.x&#39;</span> <span style="color:#000;font-weight:bold">(</span>nodes: gke-dk-jan-9-default-pool-a218b1c9-55sl, 3+<span style="color:#000;font-weight:bold">)</span>

--- update persistentvolumeclaim/mysqlclaim <span style="color:#000;font-weight:bold">(</span>v1<span style="color:#000;font-weight:bold">)</span> namespace: default
  ...
  2,  <span style="color:#099">2</span>   metadata:
  <span style="color:#099">3</span>     -   annotations:
  <span style="color:#099">4</span>     -     pv.kubernetes.io/bind-completed: <span style="color:#d14">&#34;yes&#34;</span>
  <span style="color:#099">5</span>     -     pv.kubernetes.io/bound-by-controller: <span style="color:#d14">&#34;yes&#34;</span>
  <span style="color:#099">6</span>     -     volume.beta.kubernetes.io/storage-provisioner: kubernetes.io/gce-pd
  7,  <span style="color:#099">3</span>     creationTimestamp: <span style="color:#d14">&#34;2020-03-08T22:17:29Z&#34;</span>
  8,  <span style="color:#099">4</span>     finalizers:
  ...
 24, <span style="color:#099">20</span>     storageClassName: standard
 <span style="color:#099">25</span>     -   volumeMode: Filesystem
 26, <span style="color:#099">21</span>     volumeName: pvc-1be63b2b-20de-429c-863a-9e7eb062f5d3
 27, <span style="color:#099">22</span>   status:

Changes

Namespace  Name        Kind                   Conds.  Age  Op      Wait to    Rs  Ri
default    mysqlclaim  PersistentVolumeClaim  -       43s  update  reconcile  ok  -

Op:      <span style="color:#099">0</span> create, <span style="color:#099">0</span> delete, <span style="color:#099">1</span> update, <span style="color:#099">0</span> noop
Wait to: <span style="color:#099">1</span> reconcile, <span style="color:#099">0</span> delete, <span style="color:#099">0</span> noop

Continue? <span style="color:#000;font-weight:bold">[</span>yN<span style="color:#000;font-weight:bold">]</span>:
</code></pre></div><p>To let kapp know that these annotations should be copied from the live resource copy, we can augment deploys with following configuration <code>kapp-config.yml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#555">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>kapp.k14s.io/v1alpha1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Config<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">rebaseRules</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000080">path</span>:<span style="color:#bbb"> </span>[metadata, annotations, pv.kubernetes.io/bind-completed]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">type</span>:<span style="color:#bbb"> </span>copy<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">sources</span>:<span style="color:#bbb"> </span>[new, existing]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">resourceMatchers</span>:<span style="color:#bbb"> </span><span style="color:#999;font-weight:bold;font-style:italic">&amp;pvcs</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#000080">apiVersionKindMatcher</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>PersistentVolumeClaim<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000080">path</span>:<span style="color:#bbb"> </span>[metadata, annotations, pv.kubernetes.io/bound-by-controller]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">type</span>:<span style="color:#bbb"> </span>copy<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">sources</span>:<span style="color:#bbb"> </span>[new, existing]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">resourceMatchers</span>:<span style="color:#bbb"> </span><span style="color:#999;font-weight:bold;font-style:italic">*pvcs</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000080">path</span>:<span style="color:#bbb"> </span>[metadata, annotations, volume.beta.kubernetes.io/storage-provisioner]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">type</span>:<span style="color:#bbb"> </span>copy<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">sources</span>:<span style="color:#bbb"> </span>[new, existing]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">resourceMatchers</span>:<span style="color:#bbb"> </span><span style="color:#999;font-weight:bold;font-style:italic">*pvcs</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000080">path</span>:<span style="color:#bbb"> </span>[spec, volumeMode]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">type</span>:<span style="color:#bbb"> </span>copy<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">sources</span>:<span style="color:#bbb"> </span>[new, existing]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">resourceMatchers</span>:<span style="color:#bbb"> </span><span style="color:#999;font-weight:bold;font-style:italic">*pvcs</span><span style="color:#bbb">
</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kapp deploy -a <span style="color:#0086b3">test</span> -f config.yml -f rules.yml -c

Target cluster <span style="color:#d14">&#39;https://x.x.x.x&#39;</span> <span style="color:#000;font-weight:bold">(</span>nodes: gke-dk-jan-9-default-pool-a218b1c9-55sl, 3+<span style="color:#000;font-weight:bold">)</span>

Changes

Namespace  Name  Kind  Conds.  Age  Op  Wait to  Rs  Ri

Op:      <span style="color:#099">0</span> create, <span style="color:#099">0</span> delete, <span style="color:#099">0</span> update, <span style="color:#099">0</span> noop
Wait to: <span style="color:#099">0</span> reconcile, <span style="color:#099">0</span> delete, <span style="color:#099">0</span> noop

Succeeded
</code></pre></div>
          </div>
        </div>
      </div>
    </main>
    <footer>
	<div class="wrapper footer-links">
		<div class="clearfix">
			<ul class="left-links">
				<li><a href="https://twitter.com/carvel_dev"><img src="/img/twitter.png" />Twitter</a></li>
				<li><a href="https://github.com/vmware-tanzu/carvel.dev"><img src="/img/github.svg" />Github</a></li>
				<li><a href="https://kubernetes.slack.com/archives/CH8KCCKA5">
					<img src="/img/slack.png" />
					<span class="desktop">#carvel in Kubernetes Slack</span>
					<span class="mobile">Slack</span>
				</a></li>
			</ul>
			<div class="right-links">
				<a href="/"> <img src="/img/logo.svg" /></a>
			</div>
		</div>
		<div class="bottom-links">
			<p class="copywrite">&copy; 2021 Carvel Authors. <a href="http://vmware.github.io/">A VMware-backed project. <img src="/img/vm-logo.svg" /></a></p>
		</div>
	</div>
</footer>

    
    
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
      <script type="text/javascript">
        docsearch({
          apiKey: '582b1408d7a3fe145c0f84f48ca03755',
          indexName: 'carvel',
          inputSelector: '.docsearch-input',
          algoliaOptions: {'facetFilters': ["tags:kapp"], hitsPerPage: 9},
          debug: false 
        });
      </script>
    
  </body>
</html>
